#!/bin/bash
# Cleans all build artifacts and custom config from the repo.
# Intended for use on developer workstations. Should NOT be run
# on production Admin Workstations.
set -e
set -u


function remove_unwanted_files() {

    # Remove any Onion URL info from previous instances.
    rm -vf install_files/ansible-base/app-source-ths \
        install_files/ansible-base/app-ssh-aths \
        install_files/ansible-base/app-journalist-aths \
        install_files/ansible-base/mon-ssh-aths \
        build/*.deb

    # Python bytecode, left over from tests or local app runs.
    find -type f -iname '*.pyc' -delete

    # Ansible playbook retry files, which are never used.
    find -type f -iname '*.retry' -delete

    # Static assests generated by local dev, as well as
    # virtualenv for securedrop-admin script.
    rm -rvf securedrop/static/.webassets-cache .venv

    # Any and all git-ignored files, if present. Includes e.g.
    # deb packages in build/
    git clean -f -x
}


function confirmation_prompt() {
    # Display scary warning as last chance to avoid destructive action.
    cat <<-WARNING_MESSAGE
WARNING: Proceeding will destroy all local customizations, including
application configuration, user credentials, Onion URLs, static assets,
VMs, and all git-ignored files. It is NOT possible to undo these changes!
WARNING_MESSAGE

    # We want to avoid mistakes here, so force developers
    # to type 'yes' in order to confirm and proceed with cleanup.
    read -r -p "To proceed, type 'yes': " user_confirmation
    printf "\\n"
    case "${user_confirmation}" in
        yes ) remove_unwanted_files;;
        * ) printf "Action declined, exiting...\\n"
    esac
}


confirmation_prompt
