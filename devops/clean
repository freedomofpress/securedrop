#!/bin/bash
# Cleans all build artifacts and custom config from the repo.
# Intended for use on developer workstations. Should NOT be run
# on production Admin Workstations.
set -e
set -u


function remove_unwanted_files() {

    # Remove any Onion URL info from previous instances.
    rm -vf install_files/ansible-base/app-source-ths \
        install_files/ansible-base/app-ssh-aths \
        install_files/ansible-base/app-journalist-aths \
        install_files/ansible-base/mon-ssh-aths \
        build/*.deb

    # Remove extraneous copies of the git repos, pulled in
    # via the Molecule upgrade testing scenario.
    rm -rf molecule/upgrade/.molecule/sd-orig \
        molecule/vagrant-packager/.molecule/sd-orig

    # Python bytecode, left over from tests or local app runs.
    find "$PWD" -type f -iname '*.pyc' -delete

    # Ansible playbook retry files, which are never used.
    find "$PWD" -type f -iname '*.retry' -delete

    # Static assests generated by local dev, as well as
    # virtualenv for securedrop-admin script.
    rm -rvf securedrop/static/.webassets-cache .venv

    # Any Vagrant VMs should be destroyed. We check for the .vagrant/
    # directory, because it'll be created by vagrant otherwise, breaking
    # idempotence for the cleanup action.
    if hash vagrant &> /dev/null && [[ -d .vagrant/ ]]
    then
        printf "Removing vagrant VMs..."
        # Using `|| true` as different versions of Vagrant exit different
        # status codes depending on VM state during destroy.
        vagrant destroy -f > /dev/null || true
        printf " done\n"
    fi

    # Any and all git-ignored files and directories, if present. Includes e.g.
    # deb packages in build/, and VM information stored locally.
    git clean -x -d -f
}


function confirmation_prompt() {
    # Display scary warning as last chance to avoid destructive action.
    cat <<-WARNING_MESSAGE
WARNING: Proceeding will destroy all local customizations, including
application configuration, user credentials, Onion URLs, static assets,
VMs, and all git-ignored files. It is NOT possible to undo these changes!
WARNING_MESSAGE

    # We want to avoid mistakes here, so force developers
    # to type 'yes' in order to confirm and proceed with cleanup.
    read -r -p "To proceed, type 'yes': " user_confirmation
    case "${user_confirmation}" in
        yes ) remove_unwanted_files;;
        * ) printf "Action declined, exiting...\\n"
    esac
}


confirmation_prompt
