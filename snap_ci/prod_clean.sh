#!/bin/bash
set -e
set -x


# Only enabled auto-destroy for testing droplets
# if we're running in Snap-CI. If not running in Snap-CI,
# then executing this bash script will run all the tests
# locally.
if [[ "${SNAP_CI}" == "true" ]]; then
    # declare function for EXIT trap
    function cleanup {
        echo "Destroying droplet..."
        vagrant destroy /prod/ -f
    }
    # Ensure that DigitalOcean droplet will be cleaned up
    # even if script errors (e.g., if serverspec tests fail).
    trap cleanup EXIT
    # If the previous build in snap-ci failed, the droplet
    # will still exist. Ensure that it's gone with a pre-emptive destroy.
    cleanup

    # Force DigitalOcean testing in Snap-CI.
    VAGRANT_DEFAULT_PROVIDER="digital_ocean"
fi

# Find the root of the git repository. A simpler implementation
# would be `git rev-parse --show-toplevel`, but that must be run
# from inside the git repository, whereas the solution below is
# directory agnostic. Exporting this variable doesn't work in snapci,
# so it must be rerun in each stage.
repo_root=$( dirname "$( cd "$( dirname "${BASH_SOURCE[0]}"  )" && pwd )" )

# Copy staging vars for use as prod vars; will need to skip "validate" role.
# Staging config includes looser Apache rules, so filter those out.
# Also filter out the install_local_packages line.
sed -r -e 's/(app|mon)-staging/\1-prod/' \
    "${repo_root}"/install_files/ansible-base/group_vars/staging.yml | \
    sed -r -e '/apache/d' | \
    sed -r -e '/install_local_packages/d' > \
    "${repo_root}"/install_files/ansible-base/prod-specific.yml

# Make sure the environment variable is available
# to additional tasks in the testing environment.
export VAGRANT_DEFAULT_PROVIDER

if [[ "${VAGRANT_DEFAULT_PROVIDER}" == "digital_ocean" ]] ; then
    # Skip "grsec" because DigitalOcean Ubuntu 14.04 hosts don't support custom kernels.
    export ANSIBLE_ARGS="--extra-vars grsecurity=false"
fi

# Skip "validate" so reused vars don't cause failure,
# and skip "grsec" because DigitalOcean hosts don't support custom kernels.
export ANSIBLE_ARGS="${ANSIBLE_ARGS} --skip-tags=validate"

# Assume that /prod/ instances will be created from scratch, as part
# of a full provisioning run, so initial SSH connections must be
# made directly, rather than over Tor.
unset SECUREDROP_SSH_OVER_TOR

# Create target hosts, but don't provision them yet. The shell provisioner
# is only necessary for DigitalOcean hosts, and must run as a separate task
# from the Ansible provisioner, otherwise it will only run on one of the two
# hosts, due to the `ansible.limit = 'all'` setting in the Vagrantfile.
vagrant up /prod/ --no-provision --provider "${VAGRANT_DEFAULT_PROVIDER}"

# First run only the shell provisioner, to ensure the "vagrant"
# user account exists with nopasswd sudo, then run Ansible.
vagrant provision /prod/ --provision-with shell
vagrant provision /prod/ --provision-with ansible

# Surprisingly, "ansible" allows process substitution for inventory files,
# but "ansible-playbook" doesn't. Looks like DeHaan never thought of it:
# https://groups.google.com/forum/#!msg/ansible-project/MxTAXibLNy8/SWoDn-LXZrYJ
# Probably due to some +x and type:file checking for dynamic inventories,
# accidentally breaking FIFO pipes. So, create a tempfile instead.
inventory_file=$(mktemp)
echo "snapci ansible_ssh_host=localhost" > "$inventory_file"

# The prod playbook reboots servers as the final task,
# so give them time to come back up. While servers boot,
# configure Tor on the snapci test node.
ansible-playbook -i $inventory_file -c local -s "${repo_root}/install_files/ansible-base/securedrop-snapci.yml" -vv
# Ad-hoc testing shows that the above playbook run isn't
# nearly enough time for a reboot and Tor connection to bootstrap,
# so sleep for another few minutes.
sleep 180

# The prod playbook restricts SSH access to Tor ATHS,
# so tell Vagrant to read ATHS values for ssh-config.
export SECUREDROP_SSH_OVER_TOR=1

# It shouldn't be necessary to provision again, since the
# prod playbooks reboot again. In the staging environment,
# a second provision run ensures removal of /var/www/html,
# but a second provision run on prod would take forever, so
# that spectest is temporarily disabled.
# vagrant provision /prod/ --provision-with ansible

# Run serverspec tests
cd "${repo_root}/spec_tests/"
bundle exec rake spec:app-prod
bundle exec rake spec:mon-prod
