---
- name: Install dependencies for building securedrop-app-code deb package.
  apt:
    pkg: "{{ item }}"
    state: latest
  with_items: development_dependencies
  tags:
    - apt

- name: Install pip wheel.
  pip:
    name: wheel
  tags:
    - pip

- name: Clean build path
  file:
    path: /tmp/{{ securedrop_app_code_deb }}/
    state: absent
  tags:
    - build
    - cleanup

- name: Copy install_files/securedrop-app-code dir to build path
  command: cp -R {{ securedrop_app_code_deb_config }} /tmp/{{ securedrop_app_code_deb }}/
  args:
    creates: /tmp/{{ securedrop_app_code_deb }}/
  tags:
    - build

- name: Create directories in build path.
  file:
    dest: '/tmp/{{ securedrop_app_code_deb }}/{{ item }}'
    state: directory
  with_items:
    - /var
    - /var/www
    - /var/www/securedrop
    - /var/www/securedrop/static
    - /var/securedrop
  tags:
    - build

- name: Copy securedrop to build path
  shell: cp -R {{ build_app_code_dir }}/{{ item }} /tmp/{{ securedrop_app_code_deb }}/var/www/securedrop/{{ item }}
  with_items:
    - crypto_util.py
    - db.py
    - dictionaries/
    - journalist.py
    - journalist_templates/
    - management/
    - manage.py
    - request_that_secures_file_uploads.py
    - requirements/
    - secure_tempfile.py
    - source.py
    - source_templates/
    - static/css
    - static/fonts
    - static/i
    - static/js
    - store.py
    - template_filters.py
    - version.py
    - wordlist
    - worker.py
  tags:
    - build

- name: Create pip wheel archive for Debian package requirements.
  command: pip wheel -r {{ securedrop_pip_requirements }} -w /tmp/{{ securedrop_app_code_deb }}/var/securedrop/wheelhouse
  tags:
    - pip
    - build

- name: Create etc directory in build path.
  file:
    state: directory
    dest: /tmp/{{ securedrop_app_code_deb }}/etc/
  tags:
    - build

- name: Create apparmor.d directory in build path.
  file:
    state: directory
    dest: /tmp/{{ securedrop_app_code_deb }}/etc/apparmor.d
  tags:
    - build
    - apparmor

- name: Copy AppArmor profiles to build path.
  copy:
    src: "{{ item }}"
    dest: /tmp/{{ securedrop_app_code_deb }}/etc/apparmor.d/{{ item }}
  with_items: apparmor_profiles
  tags:
    - build
    - apparmor

- name: Build securedrop-app-code Debian package.
  command: dpkg-deb --build /tmp/{{ securedrop_app_code_deb }}
  tags:
    - build

- name: move the deb to the Vagrant shared folder
  command: cp /tmp/{{ securedrop_app_code_deb }}.deb {{ securedrop_repo }}/build
  tags:
    - build

- name: Remove the build path.
  file:
    state: absent
    dest: /tmp/{{ securedrop_app_code_deb }}
  tags:
    - build
    - cleanup

- name: Remove newly built Debian package from build machine.
  file:
    state: absent
    dest: /tmp/{{ securedrop_app_code_deb }}.deb
  tags:
    - build
    - cleanup
