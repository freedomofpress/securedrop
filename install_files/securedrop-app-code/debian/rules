#!/usr/bin/make -f

DEB_DH_INSTALL_ARGS=-X .git

SECUREDROP_BUILD_PLATFORM=$(shell lsb_release -sc)

%:
	dh $@ --with python-virtualenv --with systemd

override_dh_gencontrol:
	dh_gencontrol -- $(SUBSTVARS)

# Move the conffile in version control to squash the autogenerated one
# by debhelper, as files in /etc/ are automatically marked as
# conffiles.  We are shipping AppArmor profiles via this package, and
# want them to be correctly updated with each update.
override_dh_installdeb:
	dh_installdeb
	cp ${CURDIR}/debian/conffiles ${CURDIR}/debian/securedrop-app-code/DEBIAN/

override_dh_strip_nondeterminism:
	find ./debian/ -type f -name '*.pyc' -delete
	find ./debian/ -type f -name 'pip-selfcheck.json' -delete
	find -type f -name RECORD -exec sed -i -e '/.*\.pyc.*/d' {} +
	dh_strip_nondeterminism $@

override_dh_virtualenv:
	dh_virtualenv \
		--python=/usr/bin/python3.5 \
		--setuptools \
		--extra-pip-arg "--verbose" \
		--extra-pip-arg "--ignore-installed" \
		--extra-pip-arg "--no-binary=:all:" \
		--extra-pip-arg "--no-cache-dir"

#
# Have to override the automatic service handling since we have more
# than one.
#
override_dh_installinit:
	dh_installinit --noscripts

override_dh_systemd_enable:
	dh_systemd_enable --name=securedrop_rqrequeue
	dh_systemd_enable --name=securedrop_rqworker
	dh_systemd_enable --name=securedrop_shredder

override_dh_systemd_start:
	dh_systemd_start --name=securedrop_rqrequeue
	dh_systemd_start --name=securedrop_rqworker
	dh_systemd_start --name=securedrop_shredder
