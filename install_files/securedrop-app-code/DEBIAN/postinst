#!/bin/sh
# postinst script for securedrop-app-code
#
# see: dh_installdeb(1)
set -e
set -x
# summary of how this script can be called:
#        * <postinst> `configure' <most-recently-configured-version>
#        * <old-postinst> `abort-upgrade' <new version>
#        * <conflictor's-postinst> `abort-remove' `in-favour' <package>
#          <new-version>
#        * <postinst> `abort-remove'
#        * <deconfigured's-postinst> `abort-deconfigure' `in-favour'
#          <failed-install-package> <version> `removing'
#          <conflicting-package> <version>
# for details, see http://www.debian.org/doc/debian-policy/ or
# the debian-policy package

case "$1" in
    configure)
    pip install --no-index --find-links=/var/securedrop/wheelhouse --upgrade \
      -r /var/www/securedrop/requirements/securedrop-requirements.txt

    chown -R www-data:www-data /var/www/securedrop
    chown www-data:www-data /var/www/journalist.wsgi
    chown www-data:www-data /var/www/source.wsgi

    # Apache's default sites are not allowed by the securedrop apparmor profile
    # disable the site before putting the apache apparmor profile in enforce
    # mode.
    a2dissite 000-default
    a2dissite default-ssl
    # Stop Apache service before making changes to its AppArmor profile.
    # If the Apache service is running unconfined, and the profile is
    # set to "enforce", then apache2 will fail to restart, since it lacks
    # the ability to send signals to unconfined peers.
    service apache2 stop

    # If the profile was disabled enabled it.
    if [ -e "/etc/apparmor.d/disable/usr.sbin.apache2" ]; then
        rm /etc/apparmor.d/disable/usr.sbin.apache2
    fi

    aa-enforce /etc/apparmor.d/usr.sbin.tor
    aa-enforce /etc/apparmor.d/usr.sbin.apache2

    # Restart apache so it loads with the apparmor profiles in enforce mode.
    service apache2 restart

    # Version migrations

    if [ -n "$2" ] && [ "$2" = "0.3" ] ; then
      # Restore custom logo
      cp /tmp/securedrop_custom_logo.png /var/www/securedrop/static/i/logo.png
      rm /tmp/securedrop_custom_logo.png
    fi

    # Repoint tor repositories to FPF mirror
    for file in "sources.list.d/deb_torproject_org_torproject_org.list" "security.list"
    do
        if [ -f "/etc/apt/$file" ]; then
            sed -i 's/deb.torproject.org\/torproject.org/tor-apt.ops.freedom.press/g' "/etc/apt/$file"
        fi
    done
    ;;

    abort-upgrade|abort-remove|abort-deconfigure)
    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
