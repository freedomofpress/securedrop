#!/bin/bash
# postinst script for securedrop-app-code
#
# see: dh_installdeb(1)
set -e
set -x
# summary of how this script can be called:
#        * <postinst> `configure' <most-recently-configured-version>
#        * <old-postinst> `abort-upgrade' <new version>
#        * <conflictor's-postinst> `abort-remove' `in-favour' <package>
#          <new-version>
#        * <postinst> `abort-remove'
#        * <deconfigured's-postinst> `abort-deconfigure' `in-favour'
#          <failed-install-package> <version> `removing'
#          <conflicting-package> <version>
# for details, see http://www.debian.org/doc/debian-policy/ or
# the debian-policy package

REQUIREMENTS="/var/www/securedrop/requirements/securedrop-requirements.txt"

# Helper fn for array membership testing
containsElement () {
  local e
  for e in "${@:2}"; do [[ "$e" == "$1" ]] && return 0; done
  return 1
}

case "$1" in
    configure)
    # Install all wheels shipped in the deb over the old ones
    pip install --no-index --find-links=/var/securedrop/wheelhouse -r $REQUIREMENTS

    # Add all current requirements to pip whitelist
    pip_whitelist=()
    for p in $(grep -oh '^[[:alnum:]-]*' $REQUIREMENTS)
    do
      pip_whitelist+=("$p")
    done

    # Uninstall all dependencies not in pip whitelist. pip will not let you
    # uninstall python packages provided by system packages, so we don't have to worry about that
    for p in $(pip list | awk '{print $1}')
    do
      if ! containsElement "$p" "${pip_whitelist[@]}"; then
        # pip lacks a '-y' argument until version 7.1.2, Ubuntu 14.04 is still
        # on 1.X and will never make it there
        yes | pip uninstall $p
      fi
    done

    chown -R www-data:www-data /var/www/securedrop
    chown www-data:www-data /var/www/document.wsgi
    chown www-data:www-data /var/www/source.wsgi

    # Apache's default sites are not allowed by the securedrop apparmor profile
    # disable the site before putting the apache apparmor profile in enforce
    # mode.
    a2dissite 000-default
    a2dissite default-ssl
    # Stop Apache service before making changes to its AppArmor profile.
    # If the Apache service is running unconfined, and the profile is
    # set to "enforce", then apache2 will fail to restart, since it lacks
    # the ability to send signals to unconfined peers.
    service apache2 stop

    # If the profile was disabled enabled it.
    if [ -e "/etc/apparmor.d/disable/usr.sbin.apache2" ]; then
        rm /etc/apparmor.d/disable/usr.sbin.apache2
    fi

    aa-enforce /etc/apparmor.d/usr.sbin.tor
    aa-enforce /etc/apparmor.d/usr.sbin.apache2

    # Restart apache so it loads with the apparmor profiles in enforce mode.
    service apache2 restart

    # Version migrations

    if [ -n "$2" ] && [ "$2" = "0.3" ] ; then
      # Restore custom logo
      cp /tmp/securedrop_custom_logo.png /var/www/securedrop/static/i/logo.png
      rm /tmp/securedrop_custom_logo.png
    fi

    ;;

    abort-upgrade|abort-remove|abort-deconfigure)
    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
