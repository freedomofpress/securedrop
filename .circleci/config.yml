---
version: 2
jobs:
  lint:
    docker:
      - image: msheiny/pressfreedomci:latest

    steps:
      - checkout

      - run:
          name: Installation pre-reqs
          command: pip install -U -r securedrop/requirements/develop-requirements.txt

      # Circle CI automatically dumps its env vars (`CIRCLE_*`), but let's
      # inspect everything.
      - run:
          name: Dump environment variables.
          command: printenv | sort

      - run:
          name: Check python version
          command: python --version || true

      - run:
          name: Check user
          command: whoami ; id -u || true


      # Intentionally *not* using `make lint` wrapper so as not to skip linting
      # steps if one fails. Continue linting in CI, and report full status.
      - run:
          name: Run docs lint
          command: make docs-lint
      - run:
          name: Run flake8 linting checks
          command: make flake8
      - run:
          name: Run HTML linting checks
          command: make html-lint

  staging-test:
    docker:
      - image: msheiny/pressfreedomci:latest
        environment:
          FPF_CI: true
          CI_SD_ENV: staging
          CI_AWS_TYPE: t2.small
          FPF_GRSEC: false
          TEST_REPORTS: /root/sd
    working_directory: /root/sd

    steps:
      - checkout

      - run:
          name: Installation pre-reqs
          command: pip install -U -r ./testinfra/requirements.txt

      - setup_remote_docker

      - run:
          name: Run molecule and manage tests
          command: make ci-go

      - run:
          name: Teardown environment
          command: make ci-teardown
          when: always

      - store_test_results:
          path: /root/sd/junit

      - store_artifacts:
          path: /root/sd/junit

workflows:
  version: 2
  securedrop_ci:
    jobs:
      - lint
      - staging-test:
          requires:
            - lint
