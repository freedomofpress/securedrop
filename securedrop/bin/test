#!/bin/bash
set -euo pipefail
set -x
Xvfb :1 -screen 0 1024x768x24 -ac +extension GLX +render -noreset &
Xvfb :2 -screen 0 1024x768x24 -ac +extension GLX +render -noreset &
Xvfb :3 -screen 0 1024x768x24 -ac +extension GLX +render -noreset &
Xvfb :4 -screen 0 1024x768x24 -ac +extension GLX +render -noreset &
haveged -F -v &
redis-server &

echo -n 4096 > /proc/sys/kernel/random/write_wakeup_threshold

touch tests/log/firefox.log
function cleanup {
  cp tests/log/firefox.log /tmp/test-results/logs/
}
trap cleanup EXIT

mkdir -p "/tmp/test-results/logs"

export PAGE_LAYOUT_LOCALES="en_US,ar,fr_FR"
pytest \
  -n 4 \
  --page-layout \
  --durations 10 \
  --junitxml=/tmp/test-results/junit.xml \
  --cov-report html:/tmp/test-results/cov_html \
  --cov-report xml:/tmp/test-results/cov.xml \
  --cov-report annotate:/tmp/test-results/cov_annotate \
  --cov=. \
  "$@"
