{% extends "base.html" %}
{% block body %}
<div id="content" class="journalist-view-single">

  <form action='/regenerate-code' method='post' id="regenerate-code">
    <input name="csrf_token" type="hidden" value="{{ csrf_token() }}"/>
    <input type="hidden" name="sid" value="{{ sid }}">

    <p class="breadcrumbs">
      <a href="/">All Sources</a>
      <i class="fa fa-chevron-right"></i>
      <strong>{{ source.journalist_designation }}</strong>
      <button type="submit" title="Generate a new random codename for this source. We recommend doing this if the first random codename is difficult to say or remember. You can generate new random codenames as many times as you like." class="plain" id="regenerate-codename-btn"><i class="fa fa-refresh"></i> <span id="regenerate-codename-btn-label">Change codename</span></button>
    </p>
  </form>

  {% if source.collection %}
    <p>The documents are stored encrypted for security. To read them, you will need to decrypt them using GPG.</p>
    <form action="/bulk" method="post">
    <div class="document-actions">
      <div id='select-container'></div>
      <button type="submit" name="action" value="download"><i class="fa fa-download"></i> Download selected</button>
      <button type="submit" name="action" value="confirm_delete" class="danger" id="delete_selected"><i class="fa fa-times"></i> Delete selected</button>
    </div>
      <ul id="submissions" class="plain submissions">
        {% for doc in source.collection %}
          <li class="submission"><input type="checkbox" name="doc_names_selected" value="{{ doc.filename }}" class="doc-check"/>
          <span class="info">
            
            <span title="count">{{ doc.filename[0] }}</span>

            |<span title="type">
              {% if doc.filename.endswith('-doc.gz.gpg') %}
                Document
                <i title="Uploaded Document" class="fa fa-file-archive-o"></i>
              {% elif doc.filename.endswith('-reply.gpg') %}
                Reply
						    <i title="Reply" class="fa fa-reply"></i>
              {% else %} 
                Message
                <i title="Messages" class="fa fa-file-text-o"></i>
              {% endif %}
            </span>
            |<span title="{{ doc.size }} bytes">{{ doc.size|filesizeformat(binary=True) }}</span>

          </span>
            {% if doc.filename.endswith('reply.gpg') %}
              <span class="file reply pull-right"><span class="filename">{{ doc.filename }}</span></span>
            {% else %}
              <span class="file pull-right"><a class="btn small" href="/col/{{ sid }}/{{ doc.filename }}"><i class="fa fa-download"></i> <span class="filename">{{ doc.filename }}</span></a></span>
            {% endif %}
          </li>
        {% endfor %}
      </ul>

      <input name="csrf_token" type="hidden" value="{{ csrf_token() }}"/>
      <input type="hidden" name="sid" value="{{ sid }}"/>
    </form>
  {% else %}
    <p><br />No documents to display.</p>
  {% endif %}

  <hr class="cut-out" />
  <hr class="no-line" />
  <h3><i class="fa fa-reply"></i> Reply</h3>
  {% if source.has_key %}
    <p>You can write a secure reply to the person who submitted these documents:</p>
    <form action="/reply" method="post" autocomplete="off">
      <input name="csrf_token" type="hidden" value="{{ csrf_token() }}"/>
      <input type="hidden" name="sid" value="{{ sid }}"/>
      <textarea name="msg" cols="72" rows="10"></textarea>
      <hr class="no-line" />
      <button id="reply-button" class="button-custom" type="submit">Submit</button>
    </form>
  {% elif source.flagged %}
    <p class="notification">You've flagged this source for reply.</p>
    <p>An encryption key will be generated for the source the next time they log in, after which you will be able to reply to the source here.</p>
  {% else %}
    <p>Click below if you would like to write a reply to this source.</p>
    <form action="/flag" method="post">
      <input type="hidden" name="sid" value="{{ sid }}"/>
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
      <button id="flag-button" class="button-custom" type="submit"><i class="fa fa-flag"></i> Flag this source for reply</button>
    </form>
  {% endif %}
  <hr class="no-line" />
  <hr class="cut-out" />
  <p>Click below to delete this source's collection. <em>Warning: If you do this, the files seen here will be unrecoverable and the source will no longer be able to login using their previous codename.</em></p>

  <form id="delete_collection" action="/col/delete/{{sid}}" method="post">
    <input name="csrf_token" type="hidden" value="{{ csrf_token() }}"/>
    <input type="hidden" name="sid" value="{{ sid }}"/>
    <input type="hidden" name="col_name" value="{{ source.journalist_designation }}"/>
    <button type="submit" class="danger"><i class="fa fa-times"></i> Delete collection</button>
  </form>

</div>
{% endblock %}
